<header class="main-header">
    <div class="container-fluid">
        <h1 class="page-title">
            <div class="container">
                eForms
            </div>
        </h1>
        <div class="pull-right">
            <button class="needs_tooltip btn btn-ar btn-success" type="button" data-toggle="tooltip" data-placement="top" title="" 
                    data-bootbox-confirm-label="Save eForm" data-bootbox-confirm="load(/Templates/New)" 
                    data-bootbox-title="Create eForm" data-bootbox-additional-classes="full-width mt-has-form" 
                    data-onsuccess="$(&quot;.modal-body form#create_eform&quot;).submit();" data-original-title="Create eForm">Create eForm</button>
        </div>
    </div>
</header>
<div class="container-fluid">
    <table border="0" cellpadding="0" cellspacing="0" class="table table-striped table-bordered table-condensed table-hover dataTable no-footer" id="check_lists" width="100%" role="grid" aria-describedby="check_lists_info" style="width: 100%;">
        <thead>
            <tr role="row">
                <th class="col-md-1 text-center" rowspan="1" colspan="1">
                    #
                </th>
                <th class="col-md-2 text-center" rowspan="1" colspan="1">
                    Created at
                </th>
                <th class="col-md-2 text-center" rowspan="1" colspan="1">
                    Updated at
                </th>
                <th class="col-md-3 text-center" rowspan="1" colspan="1">
                    Label
                </th>
                <th class="col-md-2 text-center" rowspan="1" colspan="1">
                    Deployed to
                </th>
                <th class="col-md-1 text-center" rowspan="1" colspan="1">
                    Actions
                </th>
            </tr>
        </thead>
        <tbody>
            @foreach (eFormFrontendDotNet.Models.check_lists item in @ViewBag.check_lists)
            {
                bool deployed = false;
                <tr id="eform_row_@(item.id)">
                    <td class="text-center">
                        @item.id
                    </td>
                    <td class="text-center">
                        @item.created_at
                    </td>
                    <td class="text-center">
                        @item.updated_at
                    </td>
                    <td class="text-center">
                        @item.label
                    </td>
                    <td class="text-center">
                        @foreach (eFormFrontendDotNet.Models.cases deplyed_case in item.cases.ToList())
                        {
                            <span>
                                @if (deplyed_case.site != null)
                                {
                                    @deplyed_case.site.name
                                    if (deplyed_case.workflow_state == "created")
                                    {
                                        deployed = true;
                                    }
                                }
                                else
                                {
                                    foreach (eFormFrontendDotNet.Models.check_list_sites check_list_site in item.check_list_sites.ToList())
                                    {
                                        @check_list_site.site.name
                                        if (check_list_site.workflow_state == "created")
                                        {
                                            deployed = true;
                                        }
                                    }
                                }
                            </span>
                        }
                    </td>
                    <td class="text-center">
                        @if (item.cases.Count > 0)
                        {
                            <a href="/Cases/Index/@(item.id)" class="needs_tooltip btn btn-ar btn-sm btn-default mt-edit-check-list-button" data-placement="top" data-toggle="tooltip" id="edit_check_list_@(item.id)" title="" type="button" data-original-title="Show cases">
                                <span class="glyphicon glyphicon-search" data-mt-check-list-id="@(item.id)"></span>
                            </a>
                            <a href="/Templates/Csv/@(item.id)" class="needs_tooltip btn btn-ar btn-sm btn-success" data-placement="top" data-toggle="tooltip" id="csv_check_list_@(item.id)" title="" type="button" data-original-title="Download CSV">
                                <span class="fa fa-file-text-o"></span>
                            </a>                            
                        }
                        <button class="needs_tooltip btn btn-ar btn-danger btn-sm dangerous-action" type="button" 
                                data-toggle="tooltip" data-placement="top" title="" data-href="/Templates/Delete/@(item.id)" 
                                id="case_delete_@(item.id)" data-bootbox-confirm="eval(rowInfo(@(item.id),' @(item.created_at)','@(item.label)'))" 
                                data-bootbox-title="Are you sure you want to delete the eForm? The action can not be undone!" 
                                data-onsuccess="confirm_delete_case(@(item.id))" data-original-title="Delete eForm">
                            <span class="fa fa-trash-o"></span>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
<script>
    $(document).ready(function(){
        $(document).on("ajaxSuccess", function(event, xhr, settings){
            switch (settings.type){
                case 'GET':
                    break;

                case 'POST':
                    show_notification(xhr.responseJSON.data);
                    break;
            }
        });
    });

    function rowInfo(item_id, creation_date, label) {
        for (var i = 0 ; i < arguments.length ; i++) {
            if (arguments[i] === 'null' || arguments[i] === null) {
                arguments[i] = '';
            }
        }

        return "<div class='row'><div class='col-md-4'><label>#</label></div><div class='col-md-8'>" + item_id + "</div></div>" +
               "<div class='row'><div class='col-md-4'><label>Creation_date</label></div><div class='col-md-8'>" + creation_date + "</div></div>" +
               "<div class='row'><div class='col-md-4'><label>Label:</label></div><div class='col-md-8'>" + label + "</div></div>";
    }

    function confirm_delete_case(case_id) {
        anchor_id = "case_delete_" + case_id;

        $.ajax({
            url: $("#" + anchor_id).data("href"),
            type: 'post',
            dataType: 'json',
            headers: { 'X-CSRF-Token': "" }
        }).done(function (data, status, xhr) {
            $("#eform_row_" + data.model_id).remove();
        }).fail(function () {
        }).always(function () {
        });
    }
</script>